{% extends "layout.html" %}

{% block title %}V O R T E X{% endblock %}

{% block extra_css %}
<style>
    body { cursor: none; }

    #vortex-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: radial-gradient(circle at center, #000 0%, #000 50%, #200 100%);
    }

    #figure {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 55px;
        height: 80px;
        z-index: 1000;
        cursor: pointer;
        user-select: none;
        pointer-events: auto;
        filter: drop-shadow(0 0 15px rgba(0, 0, 0, 1)) contrast(2) brightness(0.6);
        transition: filter 0.2s, transform 0.2s;
        animation: vortex-cursed-float 1s infinite ease-in-out;
    }

    @keyframes vortex-cursed-float {
        0%, 100% { 
            transform: translate(-50%, -50%) skewX(0deg);
        }
        25% { 
            transform: translate(-50%, -52%) skewX(-2deg);
        }
        50% {
            transform: translate(-50%, -48%) skewX(2deg);
        }
        75% {
            transform: translate(-50%, -52%) skewX(-1deg);
        }
    }

    #figure:hover {
        filter: drop-shadow(0 0 30px rgba(255, 0, 0, 1)) drop-shadow(0 0 60px rgba(0, 0, 0, 1)) contrast(3) brightness(0.4);
        animation: vortex-cursed-shake 0.1s infinite;
    }

    @keyframes vortex-cursed-shake {
        0%, 100% { transform: translate(-50%, -50%) rotate(0deg) scale(1.3); }
        25% { transform: translate(-52%, -48%) rotate(2deg) scale(1.35); }
        50% { transform: translate(-48%, -52%) rotate(-2deg) scale(1.3); }
        75% { transform: translate(-52%, -50%) rotate(1deg) scale(1.35); }
    }

    .monster-body {
        position: absolute;
        width: 24px;
        height: 50px;
        background: #000000;
        border-radius: 5px 5px 8px 8px;
        left: 15px;
        top: 22px;
        border: 2px solid #0a0a0a;
        box-shadow: inset 0 0 15px rgba(0,0,0,1);
        animation: vortex-body-distort 0.4s infinite;
    }

    @keyframes vortex-body-distort {
        0%, 100% { transform: scaleY(1) scaleX(1); }
        50% { transform: scaleY(1.15) scaleX(0.85); }
    }

    .monster-head {
        position: absolute;
        width: 32px;
        height: 38px;
        background: #000000;
        border-radius: 35% 35% 55% 55%;
        left: 11px;
        top: -3px;
        border: 2px solid #0a0a0a;
        box-shadow: inset 0 0 20px rgba(0,0,0,1);
        animation: vortex-head-wobble 0.35s infinite;
    }

    @keyframes vortex-head-wobble {
        0%, 100% { transform: rotate(0deg) skewX(0deg); }
        33% { transform: rotate(-4deg) skewX(2deg); }
        66% { transform: rotate(4deg) skewX(-2deg); }
    }

    .monster-eye {
        position: absolute;
        width: 8px;
        height: 13px;
        background: #ff0000;
        border-radius: 60% 40% 40% 60%;
        top: 12px;
        box-shadow: 0 0 12px #ff0000, inset 0 3px 8px rgba(0,0,0,1);
        animation: vortex-cursed-eye-glow 0.7s ease-in-out infinite;
    }

    .monster-eye.left { 
        left: 5px;
        animation-delay: 0.08s;
    }
    .monster-eye.right { 
        right: 5px; 
    }

    @keyframes vortex-cursed-eye-glow {
        0%, 100% { 
            box-shadow: 0 0 12px #ff0000, inset 0 3px 8px rgba(0,0,0,1);
            height: 13px;
            transform: scaleX(1) translateY(0);
        }
        5%, 12% {
            height: 2px;
            box-shadow: 0 0 6px #ff0000;
            transform: scaleX(1.5) translateY(5px);
        }
        50% { 
            box-shadow: 0 0 25px #ff0000, 0 0 40px #ff0000, inset 0 3px 8px rgba(0,0,0,1);
            height: 16px;
            transform: scaleX(0.7) translateY(-1px);
        }
    }

    .monster-mouth {
        position: absolute;
        width: 16px;
        height: 10px;
        background: #000000;
        border: 2px solid #ff0000;
        border-top: none;
        border-radius: 0 0 60% 60%;
        left: 50%;
        transform: translateX(-50%);
        top: 24px;
        animation: vortex-cursed-mouth-open 0.2s ease-in-out infinite;
        box-shadow: inset 0 -8px 15px rgba(255, 0, 0, 0.7), 0 4px 15px rgba(255, 0, 0, 0.5);
    }

    @keyframes vortex-cursed-mouth-open {
        0%, 100% { 
            height: 10px; 
            border-radius: 0 0 60% 60%;
        }
        50% { 
            height: 18px;
            border-radius: 0 0 70% 70%;
            transform: translateX(-50%) scaleX(1.3);
        }
    }

    .monster-arm {
        position: absolute;
        width: 7px;
        height: 32px;
        background: #000000;
        border-radius: 2px;
        top: 26px;
        border: 1px solid #0a0a0a;
        animation: vortex-cursed-arm-grab 0.25s ease-in-out infinite;
    }

    .monster-arm.left {
        left: 2px;
        transform: rotate(-50deg);
        transform-origin: top;
    }

    .monster-arm.right {
        right: 2px;
        transform: rotate(50deg);
        transform-origin: top;
        animation-delay: 0.125s;
    }

    @keyframes vortex-cursed-arm-grab {
        0%, 100% { 
            transform: rotate(-50deg) scaleY(1);
        }
        50% { 
            transform: rotate(-80deg) scaleY(1.4);
        }
    }

    .monster-arm.right {
        animation-name: vortex-cursed-arm-grab-right;
    }

    @keyframes vortex-cursed-arm-grab-right {
        0%, 100% { 
            transform: rotate(50deg) scaleY(1);
        }
        50% { 
            transform: rotate(80deg) scaleY(1.4);
        }
    }

    .monster-leg {
        position: absolute;
        width: 7px;
        height: 22px;
        background: #000000;
        border-radius: 2px 2px 4px 4px;
        top: 70px;
        border: 1px solid #0a0a0a;
        animation: vortex-cursed-leg-walk 0.2s ease-in-out infinite;
    }

    .monster-leg.left { 
        left: 17px;
    }

    .monster-leg.right { 
        right: 17px;
        animation-delay: 0.1s;
    }

    @keyframes vortex-cursed-leg-walk {
        0%, 100% { 
            transform: rotate(0deg) scaleY(1);
        }
        50% { 
            transform: rotate(30deg) scaleY(1.3);
        }
    }

    @keyframes figure-pulse {
        0%, 100% { 
            filter: drop-shadow(0 0 8px rgba(255, 0, 0, 0.3));
        }
        50% { 
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.5));
        }
    }

    .echo-text {
        position: absolute;
        color: rgba(255, 255, 255, 1);
        font-size: 2.5rem;
        pointer-events: none;
        white-space: nowrap;
        transform-origin: center;
        animation: spiral-in 2.5s ease-in forwards;
        text-shadow: 
            0 0 15px rgba(255, 255, 255, 1), 
            0 0 30px rgba(255, 100, 100, 0.8),
            0 0 45px rgba(255, 0, 0, 0.5);
        font-weight: bold;
        z-index: 100;
    }

    @keyframes spiral-in {
        0% {
            opacity: 1;
            transform: translate(0, 0) rotate(0deg) scale(2);
            filter: blur(0px);
        }
        50% {
            opacity: 1;
            filter: blur(1px);
        }
        100% {
            opacity: 0;
            transform: translate(var(--target-x), var(--target-y)) rotate(1440deg) scale(0);
            filter: blur(3px);
        }
    }

    #eye-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    .blinking-eyes {
        display: flex;
        gap: 60px;
    }

    .blink-eye {
        width: 120px;
        height: 48px;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 60% / 90%;
        position: relative;
        animation: blink-sequence 2s ease-in-out;
    }

    .blink-eye::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    }

    @keyframes blink-sequence {
        0%, 100% { transform: scaleY(1); }
        45%, 55% { transform: scaleY(0.1); }
    }
</style>
{% endblock %}

{% block content %}
<div id="vortex-container"></div>
<div id="figure">
    <div class="monster-head">
        <div class="monster-eye left"></div>
        <div class="monster-eye right"></div>
        <div class="monster-mouth"></div>
    </div>
    <div class="monster-body">
        <div class="monster-arm left"></div>
        <div class="monster-arm right"></div>
    </div>
    <div class="monster-leg left"></div>
    <div class="monster-leg right"></div>
</div>
<div id="eye-overlay">
    <div class="blinking-eyes">
        <div class="blink-eye"></div>
        <div class="blink-eye"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const vortexContainer = document.getElementById('vortex-container');
    const figure = document.getElementById('figure');
    const eyeOverlay = document.getElementById('eye-overlay');

    // Get all screams from the void
    let screams = [];
    
    async function loadScreams() {
        try {
            const response = await fetch("{{ url_for('void.get_screams') }}?limit=100");
            const data = await response.json();
            screams = data.map(s => s.content);
            
            // Start spawning echo text
            startVortex();
        } catch (e) {
            console.error("Could not load screams", e);
            // Fallback screams
            screams = [
                "help me", "i can't escape", "the void calls", "echoes forever",
                "where am I", "darkness", "screaming", "nobody hears",
                "lost in the void", "eternal", "forgotten", "silence hurts"
            ];
            startVortex();
        }
    }

    function createEchoText() {
        if (screams.length === 0) return;

        const echo = document.createElement('div');
        echo.className = 'echo-text';
        echo.textContent = screams[Math.floor(Math.random() * screams.length)];

        // Random starting position around the edge
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.max(window.innerWidth, window.innerHeight);
        const startX = Math.cos(angle) * distance;
        const startY = Math.sin(angle) * distance;

        echo.style.left = `${window.innerWidth / 2 + startX}px`;
        echo.style.top = `${window.innerHeight / 2 + startY}px`;

        // Calculate target (figure's mouth)
        const figureRect = figure.getBoundingClientRect();
        const targetX = figureRect.left + figureRect.width / 2 - (window.innerWidth / 2 + startX);
        const targetY = figureRect.top + figureRect.height / 2 - (window.innerHeight / 2 + startY);

        echo.style.setProperty('--target-x', `${targetX}px`);
        echo.style.setProperty('--target-y', `${targetY}px`);

        vortexContainer.appendChild(echo);

        // Remove after animation
        setTimeout(() => echo.remove(), 3000);
    }

    function startVortex() {
        // Start with aggressive spawning
        let spawnInterval = setInterval(createEchoText, 100);
        
        // Spawn multiple at once for overwhelming effect
        setInterval(() => {
            createEchoText();
            createEchoText();
            createEchoText();
        }, 300);
        
        // Increase chaos over time - get even faster
        let spawnRate = 100;
        setInterval(() => {
            spawnRate = Math.max(30, spawnRate - 5);
            clearInterval(spawnInterval);
            spawnInterval = setInterval(createEchoText, spawnRate);
        }, 2000);
    }

    // Click on figure -> trigger blink and return
    figure.addEventListener('click', () => {
        // Stop vortex
        vortexContainer.innerHTML = '';
        figure.style.display = 'none';
        
        // Show eyes blinking
        eyeOverlay.style.display = 'flex';
        
        // Return to scream page with "BLINK" placeholder after animation
        setTimeout(() => {
            window.location.href = "{{ url_for('void.index') }}?p=BLINK";
        }, 2000);
    });

    // Initialize
    loadScreams();
</script>
{% endblock %}

